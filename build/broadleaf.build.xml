<?xml version="1.0" encoding="UTF-8"?>
<project name="Broadleaf-internal" default="usage" basedir="..">
	<description>
            Broadleaf Build File
    </description>
	<property name="stage.dir" value="${basedir}/build/stage" />
	<property name="framework.src.dir" value="${basedir}/src-framework" />
	<property name="auxiliary.src.dir" value="${basedir}/src-auxiliary" />
	<property name="profile.src.dir" value="${basedir}/src-profile" />
	<property name="layout.src.dir" value="${basedir}/src-layout" />
	<property name="test.src.dir" value="${basedir}/src-test" />
	<property name="lib.dir" value="${basedir}/lib" />
	<property name="config.dir" value="${basedir}/config" />
	<property name="compile.lib.dir" value="${lib.dir}/compile/bin" />
	<property name="common.lib.dir" value="${lib.dir}/common" />
	<property name="spring.config.dir" value="${config.dir}/spring" />
	<property name="jdbc.config.dir" value="${config.dir}/jdbc" />
	<property name="test.output.dir" value="${basedir}/test-output" />
	<property file="${basedir}/build/build.properties" />

	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
		<classpath>
			<pathelement location="${lib.dir}/test/bin/ant-contrib-1.0b3.jar" />
		</classpath>
	</taskdef>

	<fileset id="compile.lib" dir="${compile.lib.dir}" description="compile-time dependencies">
		<include name="**/*.jar" />
	</fileset>

	<fileset id="common.lib" dir="${common.lib.dir}" description="common dependencies">
		<include name="**/*.jar" />
	</fileset>
	
	<target name="compile-all" depends="compile-profile, compile-auxiliary, compile-framework, compile-layout"/>

	<target name="compile-framework" depends="setup, compile-profile, compile-auxiliary">
		<!--
			Framework is allowed to depend on profile and auxiliary, but nothing else
		-->
		<mkdir dir="${stage.dir}/framework-jar" />

		<path id="compile-lib">
			<fileset refid="compile.lib" />
			<fileset refid="common.lib" />
			<dirset dir="${stage.dir}/profile-jar"/>
			<dirset dir="${stage.dir}/auxiliary-jar"/>
		</path>

		<echo>Compiling with debug=${debug.compile}</echo>
		<javac destdir="${stage.dir}/framework-jar" srcdir="${framework.src.dir}" classpathref="compile-lib" debug="${debug.compile}"/>
	</target>
		
	<target name="build-framework-jar" depends="compile-framework, build-auxiliary-jar, build-profile-jar">
		<copy todir="${stage.dir}/framework-jar">
			<fileset dir="${framework.src.dir}">
				<include name="**/*.*" />
				<exclude name="**/*.java" />
			</fileset>
		</copy>

		<copy tofile="${stage.dir}/framework-jar/applicationContext.xml">
			<fileset dir="${spring.config.dir}">
				<include name="applicationContext.xml" />
			</fileset>
		</copy>

		<copy tofile="${stage.dir}/framework-jar/jdbc.properties">
			<fileset dir="${jdbc.config.dir}">
				<include name="jdbc.properties" />
			</fileset>
		</copy>

		<if>
			<equals arg1="${hibernate.hbm2ddl.auto}" arg2="false" />
			<then>
				<replace file="${stage.dir}/framework-jar/META-INF/persistence-framework-catalog.xml">
					<replacetoken><![CDATA[<property name="hibernate.hbm2ddl.auto" value="update"/>]]></replacetoken>
					<replacevalue><![CDATA[<!-- <property name="hibernate.hbm2ddl.auto" value="update"/>-->]]></replacevalue>
				</replace>
				<replace file="${stage.dir}/framework-jar/META-INF/persistence-framework-user.xml">
					<replacetoken><![CDATA[<property name="hibernate.hbm2ddl.auto" value="update"/>]]></replacetoken>
					<replacevalue><![CDATA[<!-- <property name="hibernate.hbm2ddl.auto" value="update"/>-->]]></replacevalue>
				</replace>
				<replace file="${stage.dir}/framework-jar/META-INF/persistence-framework-secure.xml">
					<replacetoken><![CDATA[<property name="hibernate.hbm2ddl.auto" value="update"/>]]></replacetoken>
					<replacevalue><![CDATA[<!-- <property name="hibernate.hbm2ddl.auto" value="update"/>-->]]></replacevalue>
				</replace>
			</then>
		</if>

		<jar jarfile="${stage.dir}/broadleaf-framework.jar">
			<fileset dir="${stage.dir}/framework-jar">
				<include name="**/*.class" />
				<include name="**/*.properties" />
				<include name="**/*.xml" />
				<include name="**/*.vm" />
				<include name="**/*.mvel" />
				<include name="META-INF/**" />
				<exclude name="**/test/**/*.class" />
			</fileset>
		</jar>
	</target>

	<target name="build-framework-source-jar" depends="build-auxiliary-source-jar, build-profile-source-jar">
		<delete file="${stage.dir}/broadleaf-framework-sources.jar" />
		<jar jarfile="${stage.dir}/broadleaf-framework-sources.jar" basedir="${framework.src.dir}">
			<include name="**/*.java" />
			<include name="**/*.properties" />
			<include name="**/*.xml" />
			<include name="META-INF/**" />
			<exclude name="**/test/**/*.class" />
		</jar>
	</target>
	
	<target name="compile-auxiliary" depends="setup">
		<!--
			Auxiliary is not allowed to depend on other modules
		-->
		<mkdir dir="${stage.dir}/auxiliary-jar" />

		<path id="compile-lib">
			<fileset refid="compile.lib" />
			<fileset refid="common.lib" />
		</path>

		<echo>Compiling with debug=${debug.compile}</echo>
		<javac destdir="${stage.dir}/auxiliary-jar" srcdir="${auxiliary.src.dir}" classpathref="compile-lib" debug="${debug.compile}"/>
	</target>

	<target name="build-auxiliary-jar" depends="compile-auxiliary">
		<copy todir="${stage.dir}/auxiliary-jar">
			<fileset dir="${auxiliary.src.dir}">
				<include name="**/*.*" />
				<exclude name="**/*.java" />
			</fileset>
		</copy>

		<copy tofile="${stage.dir}/auxiliary-jar/jdbc.properties">
			<fileset dir="${jdbc.config.dir}">
				<include name="jdbc.properties" />
			</fileset>
		</copy>

		<jar jarfile="${stage.dir}/broadleaf-auxiliary.jar">
			<fileset dir="${stage.dir}/auxiliary-jar">
				<include name="**/*.class" />
				<include name="**/*.properties" />
				<include name="**/*.txt" />
				<include name="**/*.xml" />
				<include name="META-INF/**" />
				<exclude name="**/test/**/*.class" />
			</fileset>
		</jar>

	</target>

	<target name="build-auxiliary-source-jar">
		<delete file="${stage.dir}/build-auxiliary-source-jar" />
		<jar jarfile="${stage.dir}/broadleaf-auxiliary-sources.jar" basedir="${auxiliary.src.dir}">
			<include name="**/*.java" />
			<include name="**/*.properties" />
			<include name="**/*.xml" />
			<include name="META-INF/**" />
			<exclude name="**/test/**/*.class" />
		</jar>
	</target>

	<target name="generate-javadocs">
		<mkdir dir="${stage.dir}/javadocs" />

		<path id="compile-lib">
			<fileset refid="compile.lib" />
			<fileset refid="common.lib" />
		</path>

		<javadoc packagenames="org.broadleafcommerce.*" destdir="${stage.dir}/javadocs" classpathref="compile-lib" useexternalfile="true">
			<fileset dir="${framework.src.dir}">
				<include name="**/*.java" />
			</fileset>
		</javadoc>
	</target>
	
	<target name="compile-layout" depends="setup, compile-auxiliary, compile-profile, compile-framework">
		<!--
			Layout is allowed to depend on all other modules
		-->
		<mkdir dir="${stage.dir}/layout-jar" />

		<path id="compile-lib">
			<fileset refid="compile.lib" />
			<fileset refid="common.lib" />
			<dirset dir="${stage.dir}/profile-jar"/>
			<dirset dir="${stage.dir}/auxiliary-jar"/>
			<dirset dir="${stage.dir}/framework-jar"/>
		</path>

		<echo>Compiling with debug=${debug.compile}</echo>
		<javac destdir="${stage.dir}/layout-jar"
			srcdir="${layout.src.dir}" classpathref="compile-lib" debug="${debug.compile}"/>
	</target>

	<target name="build-layout-jar" depends="compile-layout, build-auxiliary-jar, build-profile-jar, build-framework-jar">
		<copy todir="${stage.dir}/layout-jar">
			<fileset dir="${layout.src.dir}">
				<include name="**/*.*" />
				<exclude name="**/*.java" />
			</fileset>
			<fileset dir="${config.dir}">
				<include name="**/*.properties" />
			</fileset>
		</copy>

		<jar jarfile="${stage.dir}/broadleaf-layout.jar">
			<fileset dir="${stage.dir}/layout-jar">
				<include name="**/*.class" />
				<include name="**/*.properties" />
				<include name="**/*.xml" />
				<include name="META-INF/**" />
				<exclude name="**/test/**/*.class" />
			</fileset>
		</jar>
	</target>

	<target name="build-layout-source-jar" depends="build-auxiliary-source-jar, build-profile-source-jar, build-framework-source-jar">
		<delete file="${stage.dir}/broadleaf-layout-sources.jar" />
		<jar jarfile="${stage.dir}/broadleaf-layout-sources.jar" basedir="${layout.src.dir}">
			<include name="**/*.java" />
			<include name="**/*.properties" />
			<include name="**/*.xml" />
			<include name="META-INF/**" />
			<exclude name="**/test/**/*.class" />
		</jar>
	</target>
	
	<target name="compile-profile" depends="setup">
		<!--
			Profile is not allowed to depend on any of the other modules
		-->
		<mkdir dir="${stage.dir}/profile-jar" />

		<path id="compile-lib">
			<fileset refid="compile.lib" />
			<fileset refid="common.lib" />
		</path>

		<echo>Compiling with debug=${debug.compile}</echo>
		<javac destdir="${stage.dir}/profile-jar"
			srcdir="${profile.src.dir}" classpathref="compile-lib" debug="${debug.compile}"/>
	</target>

	<target name="build-profile-jar" depends="compile-profile, build-auxiliary-jar">
		<copy todir="${stage.dir}/profile-jar">
			<fileset dir="${profile.src.dir}">
				<include name="**/*.*" />
				<exclude name="**/*.java" />
			</fileset>
			<fileset dir="${config.dir}">
				<include name="**/*.properties" />
				<include name="**/*.vm" />
			</fileset>
		</copy>

		<if>
			<equals arg1="${hibernate.hbm2ddl.auto}" arg2="false" />
			<then>
				<replace file="${stage.dir}/profile-jar/META-INF/persistence-profile.xml">
					<replacetoken><![CDATA[<property name="hibernate.hbm2ddl.auto" value="update"/>]]></replacetoken>
					<replacevalue><![CDATA[<!-- <property name="hibernate.hbm2ddl.auto" value="update"/>-->]]></replacevalue>
				</replace>
			</then>
		</if>

		<jar jarfile="${stage.dir}/broadleaf-profile.jar">
			<fileset dir="${stage.dir}/profile-jar">
				<include name="**/*.class" />
				<include name="**/*.properties" />
				<include name="**/*.xml" />
				<include name="**/*.vm" />
				<include name="META-INF/**" />
				<exclude name="**/test/**/*.class" />
			</fileset>
		</jar>
	</target>

	<target name="build-profile-source-jar" depends="build-auxiliary-source-jar">
		<delete file="${stage.dir}/broadleaf-profile-sources.jar" />
		<jar jarfile="${stage.dir}/broadleaf-profile-sources.jar" basedir="${profile.src.dir}">
			<include name="**/*.java" />
			<include name="**/*.properties" />
			<include name="**/*.xml" />
			<include name="**/*.vm" />
			<include name="META-INF/**" />
			<exclude name="**/test/**/*.class" />
		</jar>
	</target>

	<target name="build-jars" depends="build-framework-jar,build-auxiliary-jar,build-profile-jar,build-layout-jar"/>

	<target name="build-source-jars" depends="build-framework-source-jar,build-auxiliary-source-jar,build-profile-source-jar,build-layout-source-jar"/>

    <target name="publish-jars"
            depends="build-jars, build-source-jars"
            description="Publishes all artifacts from this build to the shared repository">
    	<copy file="${stage.dir}/broadleaf-auxiliary.jar" todir="${basedir}/../libraries/org.broadleafcommerce/auxiliary/0.0.0/jars" overwrite="true"/>
    	<copy file="${stage.dir}/broadleaf-auxiliary-sources.jar" todir="${basedir}/../libraries/org.broadleafcommerce/auxiliary/0.0.0/sources" overwrite="true"/>
    	<copy file="${stage.dir}/broadleaf-framework.jar" todir="${basedir}/../libraries/org.broadleafcommerce/framework/0.0.0/jars" overwrite="true"/>
    	<copy file="${stage.dir}/broadleaf-framework-sources.jar" todir="${basedir}/../libraries/org.broadleafcommerce/framework/0.0.0/sources" overwrite="true"/>
    	<copy file="${stage.dir}/broadleaf-layout.jar" todir="${basedir}/../libraries/org.broadleafcommerce/layout/0.0.0/jars" overwrite="true"/>
    	<copy file="${stage.dir}/broadleaf-layout-sources.jar" todir="${basedir}/../libraries/org.broadleafcommerce/layout/0.0.0/sources" overwrite="true"/>
       	<copy file="${stage.dir}/broadleaf-profile.jar" todir="${basedir}/../libraries/org.broadleafcommerce/profile/0.0.0/jars" overwrite="true"/>
       	<copy file="${stage.dir}/broadleaf-profile-sources.jar" todir="${basedir}/../libraries/org.broadleafcommerce/profile/0.0.0/sources" overwrite="true"/>
    </target>

	<target name="clean">
		<delete dir="${stage.dir}" />
		<delete dir="${test.output.dir}" />
	</target>

	<target name="setup" depends="clean">
		<echo>Setting up for environment = ${build.env}</echo>
		<mkdir dir="${stage.dir}" />
		<if>
			<equals arg1="${build.env}" arg2="dev" />
			<then>
				<property name="debug.compile" value="true" />
			</then>
			<elseif>
				<equals arg1="${build.env}" arg2="test" />
				<then>
					<property name="debug.compile" value="true" />
				</then>
			</elseif>
			<else>
				<property name="debug.compile" value="false" />
			</else>
		</if>
	</target>

	<target name="usage">
		<echo>
			This is an internal ANT build file.
			For development, use the targets in build.xml.
		</echo>
	</target>
</project>