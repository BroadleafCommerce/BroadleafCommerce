<?xml version="1.0" encoding="UTF-8"?>

<project name="BroadleafCommerce - Cobertura" default="instrument" basedir="../../">

	<property name="build.dir" value="${basedir}/build"/>
	<property name="stage.dir" value="${build.dir}/stage"/>
	<property name="lib.dir" value="${basedir}/lib"/>
	<property name="common.lib.dir" value="${lib.dir}/common" />
	<property name="cobertura.lib.dir" value="${lib.dir}/cobertura/bin"/>
	<property name="cobertura.instrumented.classes" value="${stage.dir}/instrumented-classes"/>

	<!-- All reports go into this directory -->
	<property name="reports.dir" value="${stage.dir}/cobertura_reports"/>

	<fileset id="cobertura.lib" dir="${cobertura.lib.dir}"
        description="cobertura dependencies">
		<include name="**/*.jar"/>
	</fileset>

	<path id="jars.dir">
		<fileset dir="${cobertura.lib.dir}">
			<include name="cobertura.jar"/>
		</fileset>
		<fileset dir="${lib.dir}">
			<include name="**/*.jar" />
		</fileset>
	</path>

	<path id="common.lib">
		<fileset dir="${common.lib.dir}"
	        description="common dependencies">
			<include name="**/*.jar"/>
		</fileset>
	</path>

	<taskdef classpathref="jars.dir" resource="tasks.properties"/>

	<target name="clean" description="Remove all files created by the build/test process.">
        <delete dir="${classes.dir}" />
        <delete dir="${cobertura.instrumented.classes}" />
        <delete dir="${reports.dir}" />
        <delete file="cobertura.log" />
        <delete file="cobertura.ser" />
    </target>

	<target name="init">
		<mkdir dir="${cobertura.instrumented.classes}" />
	</target>

	<target name="instrument" depends="clean, init">
		<cobertura-instrument todir="${cobertura.instrumented.classes}" datafile="${cobertura.instrumented.classes}/cobertura.ser" classpathref="common.lib">
			<ignore regex="org.apache.log4j.*" />

			<fileset dir="${stage.dir}">
				<exclude name="*test*.jar"/>
				<include name="broadleaf-auxiliary-web.jar" />
				<include name="broadleaf-auxiliary.jar" />
				<include name="broadleaf-framework-web.jar" />
				<include name="broadleaf-framework.jar" />
				<include name="broadleaf-layout.jar" />
				<include name="broadleaf-profile-web.jar" />
				<include name="broadleaf-profile.jar" />
			</fileset>
		</cobertura-instrument>
	</target>

   <target name="reports.generate">
        <cobertura-report format="html" destdir="${reports.dir}"
        	datafile="${cobertura.instrumented.classes}/cobertura.ser">
            <fileset dir="src-auxiliary">
                <include name="**/*.java" />
                <exclude name="**/*.xml" />
            </fileset>
            <fileset dir="src-framework">
                <include name="**/*.java" />
                <exclude name="**/*.xml" />
            </fileset>
            <fileset dir="src-layout">
                <include name="**/*.java" />
                <exclude name="**/*.xml" />
            </fileset>
            <fileset dir="src-profile">
                <include name="**/*.java" />
                <exclude name="**/*.xml" />
            </fileset>
        </cobertura-report>

        <cobertura-report format="xml" destdir="${reports.dir}"
            datafile="${cobertura.instrumented.classes}/cobertura.ser">
            <fileset dir="src-auxiliary">
                <include name="**/*.java" />
                <exclude name="**/*.xml" />
            </fileset>
            <fileset dir="src-framework">
                <include name="**/*.java" />
                <exclude name="**/*.xml" />
            </fileset>
            <fileset dir="src-layout">
                <include name="**/*.java" />
                <exclude name="**/*.xml" />
            </fileset>
            <fileset dir="src-profile">
                <include name="**/*.java" />
                <exclude name="**/*.xml" />
            </fileset>
        </cobertura-report>
    </target>

</project>