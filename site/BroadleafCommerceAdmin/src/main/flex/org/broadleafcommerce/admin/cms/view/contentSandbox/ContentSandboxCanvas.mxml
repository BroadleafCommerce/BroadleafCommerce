<?xml version="1.0" encoding="utf-8"?>
<!--
/*
 * Copyright 2008-2009 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
-->
<mx:VBox xmlns:mx="http://www.adobe.com/2006/mxml"
	xmlns:view="org.broadleafcommerce.admin.cms.view.*"
	creationComplete="handleCreationComplete()"
	xmlns:control="org.broadleafcommerce.admin.cms.control.*"
	xmlns:contentSandbox="org.broadleafcommerce.admin.cms.view.contentSandbox.*">
	<mx:Script>
		<![CDATA[
			import org.broadleafcommerce.admin.core.model.ConfigModel;
			import org.broadleafcommerce.admin.cms.control.events.RemoveContentTabEvent;
			import org.broadleafcommerce.admin.cms.control.events.RejectContentEvent;
			import org.broadleafcommerce.admin.cms.view.contentCreation.ContentChooseTypeModal;
			import org.broadleafcommerce.admin.cms.control.events.CreateEditContentEvent;
			import org.broadleafcommerce.admin.cms.model.util.ContentUtil;
			import org.broadleafcommerce.admin.cms.control.events.AddContentTabEvent;
			import org.broadleafcommerce.admin.cms.view.contentCreation.ContentAddEditPage;
			import org.broadleafcommerce.admin.cms.control.events.ApproveContentEvent;
			import mx.controls.Alert;
			import org.broadleafcommerce.admin.cms.control.events.SubmitContentFromSandboxEvent;
			import mx.collections.ArrayCollection;
			import org.broadleafcommerce.admin.core.model.AppModelLocator;
			import org.broadleafcommerce.admin.core.model.AuthenticationModel;
			import org.broadleafcommerce.admin.cms.model.ContentModel;
			import org.broadleafcommerce.admin.cms.model.ContentModelLocator;
			import org.broadleafcommerce.admin.cms.control.events.ReadContentForSandboxEvent;
			import org.broadleafcommerce.admin.cms.vo.Content;
			import mx.managers.PopUpManager;
			import mx.containers.TitleWindow;

			[Bindable]
			private var authModel:AuthenticationModel = AppModelLocator.getInstance().authModel;

			[Bindable]
			private var contentModel:ContentModel = ContentModelLocator.getInstance().contentModel;

			[Bindable]
			public var content:ArrayCollection;

			[Bindable]
			public var sandboxName:String;

			private function handleCreationComplete():void{
				trace("DEBUG: ContentSandboxCanvas.handleCreationComplete()");
				if (content == null || sandboxName == null){
					Alert.show("Error: content and name for sandbox should not be null");
				}

				this.contentSandboxDataGrid.tabName = this.parent.name;
			}

			private function handlePreviewClick(event:Event):void{
				var urlRequest:URLRequest = new URLRequest(AppModelLocator.getInstance().configModel.urlServer + "?blcSandbox=" + sandboxName);
                navigateToURL(urlRequest, "_blank");
			}

			private function handleAddClick(event:Event):void{
				var newContentModal:TitleWindow = TitleWindow(PopUpManager.createPopUp(this, ContentChooseTypeModal, true));
				ContentChooseTypeModal(newContentModal).sandboxName = sandboxName;
				ContentChooseTypeModal(newContentModal).tabName = this.parent.name;
			}

			private function handleSubmitClick(event:Event):void{
				var contentIds:ArrayCollection = retrieveSelectedContentIds();
				if (contentIds != null) {
					var submissionModal:TitleWindow = TitleWindow(PopUpManager.createPopUp(this, ContentSubmitModal , true));
					ContentSubmitModal(submissionModal).contentIds = contentIds;
					ContentSubmitModal(submissionModal).sandboxName = sandboxName;
					ContentSubmitModal(submissionModal).user = authModel.userPrincipal.login;
					ContentSubmitModal(submissionModal).tabName = this.parent.name;
				}
			}

			private function handleApproveClick(event:Event):void{
				var contentIds:ArrayCollection = retrieveSelectedContentIds();
				if (contentIds != null) {
					new ApproveContentEvent(contentIds, sandboxName, authModel.userPrincipal.login, this.parent.name).dispatch();
				}
			}

			private function handleRejectClick(event:Event):void{
				var contentIds:ArrayCollection = retrieveSelectedContentIds();
				if (contentIds != null) {
					new RejectContentEvent(contentIds, sandboxName, authModel.userPrincipal.login, this.parent.name).dispatch();
				}
			}

			private function handleCancelClick(event:Event):void{
				new RemoveContentTabEvent(this.parent.name).dispatch();
			}

			private function retrieveSelectedContentIds():ArrayCollection{
				var selectedIndices:Array = this.contentSandboxDataGrid.selectedIndices;
				if (selectedIndices.length > 0) {
					var contentIds:ArrayCollection = new ArrayCollection();

					for(var i:Number = 0; i<selectedIndices.length; i++){
						var contentItem:Content = content.getItemAt(selectedIndices[i]) as Content;
						contentIds.addItem(contentItem.id);
					}
					return contentIds;
				} else {
					return null;
				}
			}
		]]>
	</mx:Script>

	<mx:Binding
		source="content"
		destination="contentSandboxDataGrid.dataProvider"/>

		<mx:Label text="Viewing Sandbox: {sandboxName}" fontSize="20"/>

		<mx:HBox>
			<mx:Button id="previewButton" label="Preview" click="handlePreviewClick(event)" styleName="previewButton" />
			<mx:Button id="addButton" label="Create New Content" styleName="addButton" click="handleAddClick(event)"/>
		</mx:HBox>
		<mx:HBox
			width="100%" height="100%">
			<contentSandbox:ContentSandboxDataGrid
				id="contentSandboxDataGrid" height="100%" width="100%"/>
		</mx:HBox>
		<mx:HBox>
			<!-- If role == CONTENT_APPROVER -->
			<mx:Button id="approveButton" label="Approve" click="handleApproveClick(event)" visible="{contentModel.contentRoles.isContentApprover}" includeInLayout="{contentModel.contentRoles.isContentApprover}"/>

			<!-- If role == CONTENT_APPROVER -->
			<mx:Button id="rejectButton" label="Reject" click="handleRejectClick(event)" visible="{contentModel.contentRoles.isContentApprover}" includeInLayout="{contentModel.contentRoles.isContentApprover}"/>

			<!-- If role == CONTENT_EDITOR -->
			<mx:Button id="submitButton" label="Submit" click="handleSubmitClick(event)" visible="{contentModel.contentRoles.isContentEditor || contentModel.contentRoles.isContentApprover}" includeInLayout="{contentModel.contentRoles.isContentEditor || contentModel.contentRoles.isContentApprover}"/>

			<!-- If role == CONTENT_DELETER -->
			<mx:Button id="deleteButton" label="Delete" visible="{contentModel.contentRoles.isContentDeleter}" includeInLayout="{contentModel.contentRoles.isContentDeleter}"/>

			<mx:Button id="cancelButton" label="Cancel" click="handleCancelClick(event)"/>

		</mx:HBox>

</mx:VBox>
